= Spring Data CDO

image::./src/main/asciidoc/images/spring-cdo-logo-white-background.png[width=50%,scalewidth=6cm]

*Current version:* 0.6.0-SNAPSHOT

*Supports CDO protocol version 48*

----

The primary goal of the https://projects.spring.io/spring-data[Spring Data] project is to make it easier to build Spring-powered applications that use new data access technologies such as non-relational databases, map-reduce frameworks, and cloud based data services.

This module provides infrastructure components to build repository abstractions for stores dealing with the
https://www.eclipse.org/cdo/[*Connected Data Objects (CDO) model repository*] of Eclipse.

== Getting Started

The standard use case of this framework is to store and read native `CDOObject`s and standard `EObject`s.
To be clear, the framework does not perform a transformation of standard Java POJOs to their Ecore representatives.
Only Java objects of class type `CDOObject` or `EObject` (and in legacy mode) are supported.
Legacy mode: Models that are not converted for CDO support.
See also https://wiki.eclipse.org/CDO/Preparing_EMF_Models[Preparing EMF Models]

Your domain models should be defined using the Eclipse EMF Ecore metamodel as usual, or dynamically at runtime.
Eclipse EMF support the generation of domain classes from Ecore models.
They can also be used afterwards with *Spring Data CDO*.

=== Working with Eclipse IDEs

This framework provides a feature to start a standalone CDO server.
To inspect the contents, use the Eclipse CDO Explorer to view and modify Ecore models:
  - 1) Download CDO Explorer via the link:https://www.eclipse.org/downloads/packages/installer[Eclipse Installer]
  Version `cdo-master-latest-release-2023-01` supporting CDO protocol version 48.
  Eclipse IDE version 2023-09 supports only CDO protocol version 49.
  - 2) Any Eclipse IDE with CDO support, must support **CDO protocol version 48**

=== Getting Started: Maven configuration

Just add the following Maven dependency to your project's `pom.xml`:

[source,xml]
----
<dependency>
  <groupId>org.springframework.data</groupId>
  <artifactId>spring-data-cdo</artifactId>
  <version>0.6.0-SNAPSHOT</version>
</dependency>

<!-- Required for the CDO standalone server -->
<dependency>
  <groupId>org.eclipse.platform</groupId>
  <artifactId>org.eclipse.core.runtime</artifactId>
  <version>3.26.100</version>
</dependency>
----

==== SNAPSHOT Releases

For SNAPSHOT releases also include the following repository:

[source,xml]
----
<repositories>
    <repository>
        <snapshots>
            <enabled>true</enabled>
        </snapshots>
        <id>ossrh</id>
        <url>https://s01.oss.sonatype.org/content/repositories/snapshots</url>
    </repository>
</repositories>
----

=== Example

The following examples show some possible configuration and usage scenarios.

==== Domain classes

The framework can handle native EMF models:

[source,java]
----
// any auto-generated object of an EMF model or native CDO model
interface Person extends EObject {}
interface Person extends CDOObject {}
----

Non-native EMF domain classes (i.e., classes that don't extend `EObject` or the `CDOObject` interface) should be annotated in the following way to provide necessary details:

[source,java]
----
@CDO(path = "your/repository/resource/path",
        nsUri = "http://www.example.org/personDomainModel",
        ePackage = PersonDomainModelPackage.class,
        ePackageBaseClass = "org.example.ecore.personDomainModel.PersonDomainModelPackage"
)
class PersonWrapper {
    @Id
    CDOID id;
    @EObjectModel(classFor=Person.class)
    public Person model;
}
----

They effectively work like a wrapper for internal members, which are of class `EObject` or `CDOObject`.
Additionally, an ID must be specified of type `CDOID` using the `@Id` annotation feature of Spring.

==== Repository Definition

[source,java]
----
@Repository
public interface PersonRepository extends CdoRepository<PersonWrapper, CDOID> {
}
----

==== Some Remarks

With regard to EMF-related programming, the respective `EPackage` must be registered in the global package registry first (see https://download.eclipse.org/modeling/emf/emf/javadoc/2.9.0/[EPackage.Registry]).
The registry provides a mapping from namespace URIs to `EPackage` instances.

> Though, this framework has some internal mechanism to initialize the EPackage in the registry automatically, it may not always find it.

We advise to initialize the corresponding `EPackage` that is going to be used with this framework by using standard mechanisms of EMF:

[source,java]
----
    @BeforeClass
    public static void beforeClass() throws Exception {
        PersonDomainModelPackageImpl.init();
        // Or: EPackage.Registry.INSTANCE.put("http://www.example.org/personDomainModel", PersonDomainModelPackage.eINSTANCE);

        // This statement should not fail:
        EPackage ePackage = EPackage.Registry.INSTANCE.getEPackage("http://www.example.org/personDomainModel");
        Assert.notNull(ePackage, "Model Package couldn't be found in the EPackage Registry.");
    }
----

Especially when working with CDO the package should be registered locally and remotely:

[source,java]
----
CdoTemplate template = new CdoTemplate(factory);
CDOPackageRegistry.INSTANCE.put(BookstoreDomainModelPackage.eNS_URI, BookstoreDomainModelPackage.eINSTANCE);
CDOPackageRegistry remoteRegistry = template.getCDOPackageRegistry(); //acquire the remote CDO package registry
EPackage ePackage = remoteRegistry.getEPackage(BookstoreDomainModelPackage.eNS_URI);
if (ePackage == null) {
    remoteRegistry.put(BookstoreDomainModelPackage.eNS_URI, BookstoreDomainModelPackage.eINSTANCE);
}
----

=== Events

When required, one can listen to specific events emitted by some repository actions for adding extended behavior.
Events are implemented for Delete, Save and Insert operations, including "after" and "before" notions for fine-grained control.


== Building from Source

You do not need to build from source to use Spring Data for CDO (dependencies are deployed to the https://repo.spring.io[Central Repository]).
But if you want to try out the latest and greatest, Spring Data for CDO can be easily built with the regular `mvn` command,
or by using the https://github.com/takari/maven-wrapper[maven wrapper].
If you want to build with the regular `mvn` command, you will need https://maven.apache.org/download.cgi[Maven v3.8.3 or above].

You also need JDK 17.

To build Spring Data for CDO, execute the following commands in the terminal:

[source,shell]
----
# get all needed Eclipse dependencies first (need only to be executed once)
./mvnw clean validate -f ./spring-data-cdo-distribution/pom.xml -PfetchEclipseDependencies
# package and install the actual 'spring-data-cdo' dependency
./mvnw clean install -DskipTests
----

The dependencies are deployed to your local Maven repository usually located at `~/.m2/`.

=== Building reference documentation

Building the documentation builds also the project without running tests.

[source,bash]
----
 $ ./mvnw clean install -DskipTests -Pdistribute
----

The generated documentation is available from `target/site/reference/html/index.html`.
The Maven profile `distribute` is provided by `spring-data-parent`.
For more information see link:https://github.com/spring-projects/spring-data-build[https://github.com/spring-projects/spring-data-build] on how to set up the Asciidoc documentation.

=== Deploy

The Java artifacts are deployed to the Central Repository:

[source,shell]
----
mvn clean deploy -DskipTests -pl '!spring-data-cdo-distribution' -P release
----

== Code of Conduct

This project is governed by the link:CODE_OF_CONDUCT.adoc[Spring Code of Conduct].
By participating, you are expected to uphold this code of conduct.
Please report unacceptable behavior to dominik.grzelak@tu-dresden.de.
